{% extends "layouts/base.html" %}
{% load static %}

{% block content %}
<section class="content">
  <div class="container-fluid">
    <div class="card card-primary card-outline">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h3 class="card-title mb-0 d-flex align-items-center">
          <i class="fas fa-tasks mr-2"></i> Tiến độ thực hiện công việc
          {% if readonly_mode %}
            <span class="badge badge-secondary ml-2">READ-ONLY</span>
          {% endif %}
        </h3>

        <div class="card-tools d-flex align-items-center">
          {% if can_view_all %}
          <div class="btn-group mr-2" role="group" aria-label="dept-filter">
            <a href="?tab={{ tab }}&dept=my"
               class="btn btn-sm {% if dept != 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}">
              <i class="fas fa-building mr-1"></i> Phòng ban của tôi
            </a>
            <a href="?tab={{ tab }}&dept=all"
               class="btn btn-sm {% if dept == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}">
              <i class="fas fa-eye mr-1"></i> Xem tất cả
            </a>
          </div>
          {% endif %}

          {% if can_view_all and dept == 'all' %}
          <form method="get" class="form-inline ml-2">
            <input type="hidden" name="tab" value="{{ tab }}">
            <input type="hidden" name="dept" value="all">

            <div class="form-group mr-2">
              <label for="dept_id" class="sr-only">Phòng ban</label>
              <select name="dept_id" id="dept_id" class="form-control form-control-sm">
                <option value="">— Tất cả phòng ban —</option>
                {% for d in departments %}
                  <option value="{{ d.id }}" {% if d.id|stringformat:"s" == dept_id %}selected{% endif %}>{{ d.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group mr-2">
              <label for="sort" class="sr-only">Sắp xếp</label>
              <select name="sort" id="sort" class="form-control form-control-sm">
                <option value="">Mới nhất</option>
                <option value="deadline_asc"  {% if sort == 'deadline_asc' %}selected{% endif %}>Deadline: gần → xa</option>
                <option value="deadline_desc" {% if sort == 'deadline_desc' %}selected{% endif %}>Deadline: xa → gần</option>
                <option value="priority_desc" {% if sort == 'priority_desc' %}selected{% endif %}>Ưu tiên: cao → thấp</option>
                <option value="priority_asc"  {% if sort == 'priority_asc' %}selected{% endif %}>Ưu tiên: thấp → cao</option>
              </select>
            </div>

            <button class="btn btn-sm btn-outline-primary">
              <i class="fas fa-filter mr-1"></i> Lọc
            </button>
          </form>
          {% endif %}

          <a href="{% url 'create_task' %}" class="btn btn-sm btn-primary">
            <i class="fas fa-plus-circle mr-1"></i> Tạo công việc mới
          </a>
        </div>
      </div>

      <div class="card-body">

        <!-- Tabs -->
        <ul class="nav nav-pills mb-3">
          <li class="nav-item">
            <a class="nav-link {% if tab == 'dang' %}active{% endif %}" href="?tab=dang&dept={{ dept|default:'my' }}">
              <i class="fas fa-spinner mr-1"></i> Đang thực hiện
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if tab == 'cho' %}active{% endif %}" href="?tab=cho&dept={{ dept|default:'my' }}">
              <i class="fas fa-hourglass-half mr-1"></i> Chờ phê duyệt
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if tab == 'chua' %}active{% endif %}" href="?tab=chua&dept={{ dept|default:'my' }}">
              <i class="fas fa-times-circle mr-1"></i> Chưa hoàn thành
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if tab == 'xong' %}active{% endif %}" href="?tab=xong&dept={{ dept|default:'my' }}">
              <i class="fas fa-check-circle mr-1"></i> Đã hoàn thành
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if tab == 'tat' %}active{% endif %}" href="?tab=tat&dept={{ dept|default:'my' }}">
              <i class="fas fa-list mr-1"></i> Tất cả
            </a>
          </li>
        </ul>

        <!-- Tiêu đề / trạng thái -->
        <div class="alert alert-info mb-3 d-flex align-items-center justify-content-between">
          <div>
            <h5 class="alert-heading mb-1">
              {% if tab == 'xong' %}
                <i class="fas fa-check-circle text-success mr-1"></i> Công việc đã hoàn thành
              {% elif tab == 'cho' %}
                <i class="fas fa-hourglass-half text-warning mr-1"></i> Công việc chờ phê duyệt
              {% elif tab == 'chua' %}
                <i class="fas fa-times-circle text-danger mr-1"></i> Công việc chưa hoàn thành
              {% elif tab == 'dang' %}
                <i class="fas fa-spinner text-primary mr-1"></i> Công việc đang thực hiện
              {% else %}
                <i class="fas fa-list text-secondary mr-1"></i> Tất cả công việc
              {% endif %}
            </h5>
            <p class="mb-0 small">Tổng số: <strong>{{ tasks|length }}</strong> công việc</p>
          </div>
          <div class="small text-muted">
            {% if dept == 'all' %}
              Bộ lọc:
              <span class="badge badge-secondary">
                Tất cả{% if readonly_mode %} (read-only){% endif %}
                {% if dept_id and departments %}
                  —
                  {% for d in departments %}
                    {% if d.id|stringformat:"s" == dept_id %}{{ d.name }}{% endif %}
                  {% endfor %}
                {% endif %}
              </span>
            {% else %}
              Bộ lọc: <span class="badge badge-primary">Phòng ban của tôi</span>
            {% endif %}
          </div>
        </div>

        <!-- Bảng -->
        <div class="table-responsive">
          <table class="table table-hover table-striped table-bordered mb-0">
            <thead class="thead-light">
              <tr>
                <th class="col-stt text-center">STT</th>
                <th class="col-title">Tên công việc</th>
                <th class="col-content">Nội dung</th>
                <th class="col-dept">Phòng ban</th>
                <th class="col-assignee">Người PT</th>
                <th class="col-progress text-center">Progress</th>
                <th class="col-updates">Cập nhật tiến độ</th>
                <th class="col-support">Hỗ trợ</th>
                <th class="col-deadline text-center">Deadline</th>
                <th class="col-feedback">Phản hồi</th>
                <th class="col-actions text-center">Thao tác</th>
              </tr>
            </thead>

            <tbody>
            {% for t in tasks %}
              {% with assignee_id=t.assignee_id %}
              <tr>
                <!-- STT -->
                <td class="text-center align-middle">{{ forloop.counter }}</td>

                <!-- Tên công việc -->
                <td class="align-middle">
                  <strong class="d-block text-truncate" title="{{ t.title }}">{{ t.title }}</strong>
                  <div class="mt-1">
                    {% if t.status == 'DONE' %}
                      <span class="badge badge-success">Hoàn thành</span>
                    {% elif t.status == 'PENDING' %}
                      <span class="badge badge-warning">Chờ duyệt</span>
                    {% elif t.status == 'DOING' %}
                      <span class="badge badge-primary">Đang thực hiện</span>
                    {% else %}
                      <span class="badge badge-secondary">Chưa bắt đầu</span>
                    {% endif %}
                    {% if t.priority == 'URGENT' %}
                      <span class="badge badge-danger">Khẩn cấp</span>
                    {% elif t.priority == 'HIGH' %}
                      <span class="badge badge-warning">Cao</span>
                    {% elif t.priority == 'MEDIUM' %}
                      <span class="badge badge-info">Trung bình</span>
                    {% elif t.priority == 'LOW' %}
                      <span class="badge badge-secondary">Thấp</span>
                    {% endif %}
                  </div>
                </td>

                <!-- Nội dung -->
                <td class="td-top">
                  <div class="cell-multiline" title="{{ t.content|default:'—' }}">
                    {{ t.content|default:"—" }}
                  </div>
                </td>

                <!-- Phòng ban -->
                <td class="align-middle">
                  <span class="badge badge-dark text-truncate d-inline-block" style="max-width: 100%;">{{ t.department|default:"—" }}</span>
                </td>

                <!-- Người phụ trách -->
                <td class="align-middle">
                  <span class="badge badge-info text-truncate d-inline-block" style="max-width: 90px;"
                        title="{{ t.assignee.get_full_name|default:t.assignee.username }}">
                    {{ t.assignee.get_short_name|default:t.assignee.username }}
                  </span>
                </td>

                <!-- % hoàn thành -->
                <td class="text-center align-middle">
                  <div class="progress progress-strong mb-1">
                    <div class="progress-bar {% if t.progress == 100 %}bg-success{% elif t.progress > 50 %}bg-primary{% else %}bg-warning{% endif %}"
                         style="width: {{ t.progress }}%"></div>
                  </div>
                  <span class="badge {% if t.progress == 100 %}badge-success{% elif t.progress > 50 %}badge-primary{% else %}badge-warning{% endif %}">
                    {{ t.progress }}%
                  </span>
                </td>

                <!-- Cập nhật tiến độ -->
                <td class="td-updates">
                  <div class="updates-cell">
                    {% with last=t.updates.all|first %}
                      <div class="update-card">
                        {% if last %}
                          <div class="uc-row">
                            <span class="uc-time">{{ last.created_at|date:"d/m H:i" }}</span>
                            <span class="badge badge-info uc-badge">{{ last.progress }}%</span>
                          </div>
                          <div class="uc-meta">{{ last.user.get_short_name|default:last.user.username }}</div>
                          {% if last.content %}
                            <div class="uc-note" title="{{ last.content }}">{{ last.content }}</div>
                          {% endif %}
                        {% else %}
                          <div class="uc-empty">Chưa có cập nhật</div>
                        {% endif %}
                      </div>
                    {% endwith %}

                    {% if not readonly_mode %}
                      {% if assignee_id == request.user.id or perms.work.can_approve %}
                        <div id="upd{{ t.pk }}" class="collapse mt-2">
                          <form method="post" action="{% url 'update_progress' t.pk %}" class="p-2 border rounded bg-light">
                            {% csrf_token %}
                            <div class="d-flex align-items-center mb-2">
                              <input type="number" name="progress" value="{{ t.progress }}" min="0" max="100"
                                     class="form-control form-control-sm mr-2" style="width: 60px;">
                              <button class="btn btn-compact btn-primary" type="submit">Lưu</button>
                            </div>
                            <textarea name="content" rows="2" class="form-control form-control-sm"
                                      placeholder="Ghi chú cập nhật..."></textarea>
                          </form>
                        </div>
                      {% endif %}
                    {% endif %}

                    <!-- nút dưới cùng -->
                    <div class="update-actions">
                      {% if not readonly_mode %}
                        {% if assignee_id == request.user.id or perms.work.can_approve %}
                          <button class="btn btn-compact btn-primary" data-toggle="collapse" data-target="#upd{{ t.pk }}">Cập nhật</button>
                        {% endif %}
                      {% endif %}

                      {% if assignee_id == request.user.id or perms.work.can_approve %}
                        <a class="btn btn-compact btn-outline-secondary" href="{% url 'task_updates' t.pk %}">Chi tiết</a>
                      {% else %}
                        <button class="btn btn-compact btn-outline-secondary" disabled title="Chỉ người phụ trách hoặc quản lý mới xem được">Chi tiết</button>
                      {% endif %}
                    </div>
                  </div>
                </td>

                <!-- Hỗ trợ -->
                <td class="align-middle">
                  {% for u in t.supporters.all %}
                    <span class="badge badge-secondary d-block mb-1 text-truncate" style="max-width: 90px;"
                          title="{{ u.get_full_name|default:u.username }}">
                      {{ u.get_short_name|default:u.username }}
                    </span>
                  {% empty %}
                    <span class="text-muted">—</span>
                  {% endfor %}
                </td>

                <!-- Deadline -->
                <td class="text-center align-middle">
                  {% if t.deadline %}
                    {% if t.is_overdue %}
                      <span class="badge badge-danger" title="Quá hạn!">
                        <i class="fas fa-exclamation-triangle mr-1"></i>{{ t.deadline|date:"d/m/Y" }}
                      </span>
                    {% else %}
                      <span class="badge badge-success">
                        <i class="far fa-calendar-alt mr-1"></i>{{ t.deadline|date:"d/m/Y" }}
                      </span>
                    {% endif %}
                    <br>
                    <small class="text-muted">
                      {% with dr=t.days_until_deadline %}
                        {% if dr < 0 %}
                          Quá {{ dr|stringformat:"d"|slice:"1:" }} ngày
                        {% elif dr == 0 %}
                          Hôm nay
                        {% else %}
                          Còn {{ dr }} ngày
                        {% endif %}
                      {% endwith %}
                    </small>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>

                <!-- Phản hồi (điểm nổi + lịch sử tách riêng, tránh trùng) -->
                <td class="align-top">
                  {% if t.approval_score %}
                    <div class="rating-card mb-2 {% if t.approval_score >= 8 %}good{% elif t.approval_score >= 5 %}medium{% else %}bad{% endif %}">
                      <div class="rc-left">
                        <i class="fas fa-star"></i>
                        <span class="rc-score">{{ t.approval_score }}</span><span class="rc-total">/10</span>
                      </div>
                      {% if t.approval_comment %}
                        <div class="rc-comment" title="{{ t.approval_comment }}">{{ t.approval_comment }}</div>
                      {% else %}
                        <div class="rc-comment muted">Không có nhận xét</div>
                      {% endif %}
                    </div>
                  {% endif %}

                  {% with last_feedback=t.manager_feedbacks.all|first %}
                    {% if last_feedback %}
                      {% if not t.approval_comment and last_feedback.content == t.approval_comment and last_feedback.manager_id == t.approver_id %}
                        <div class="history-box">
                          <div class="small text-muted">{{ last_feedback.created_at|date:"d/m" }}</div>
                          <div class="small cell-multiline" title="{{ last_feedback.content }}">{{ last_feedback.content }}</div>
                          <small class="text-muted">- {{ last_feedback.manager.get_short_name|default:last_feedback.manager.username }}</small>
                        </div>
                      {% endif %}
                    {% else %}
                      {% if not t.approval_score %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    {% endif %}
                  {% endwith %}

                  {% if perms.work.can_approve and not readonly_mode %}
                    <a class="btn btn-compact btn-outline-primary mt-2" href="{% url 'manager_feedback' t.pk %}">
                      <i class="fas fa-comment-dots mr-1"></i> Phản hồi
                    </a>
                  {% endif %}
                </td>

                <!-- Thao tác -->
                <td class="text-center align-middle">
                  {% if readonly_mode %}
                    <a class="btn btn-sm btn-outline-secondary" href="{% url 'task_updates' t.pk %}" title="Xem chi tiết">
                      <i class="fas fa-eye"></i>
                    </a>
                  {% else %}
                    <div class="btn-group-vertical btn-group-sm">
                      {% if perms.work.can_approve or t.assigned_by_id == request.user.id %}
                        <a class="btn btn-info mb-1" href="{% url 'edit_task' t.pk %}" title="Sửa công việc">
                          <i class="fas fa-edit"></i>
                        </a>
                      {% endif %}

                      {% if perms.work.can_approve and t.status != 'DONE' %}
                        <!-- Nút mở modal duyệt -->
                        <button class="btn btn-success mb-1"
                                data-toggle="modal"
                                data-target="#approveModal"
                                data-url="{% url 'approve_task' t.pk %}?modal=1"
                                title="Phê duyệt & chấm điểm">
                          <i class="fas fa-check"></i>
                        </button>
                      {% endif %}

                      {% if perms.work.can_approve or t.assigned_by_id == request.user.id %}
                      <form method="post" action="{% url 'delete_task' t.id %}" class="d-inline"
                            onsubmit="return confirm('Xóa công việc {{ t.title }}?');">
                        {% csrf_token %}
                        <button class="btn btn-danger" title="Xóa">
                          <i class="fas fa-trash"></i>
                        </button>
                      </form>
                      {% endif %}
                    </div>
                  {% endif %}
                </td>
              </tr>
              {% endwith %}
            {% empty %}
              <tr>
                <td colspan="11" class="text-center py-4">
                  <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                  <p class="text-muted mb-0">Không có công việc nào</p>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>

      </div>

      <div class="card-footer d-flex justify-content-between">
        <p class="text-muted small mb-0">Hiển thị <strong>{{ tasks|length }}</strong> công việc</p>
        {% if readonly_mode %}
          <span class="text-muted small"><i class="fas fa-eye mr-1"></i>Đang xem ở chế độ read-only</span>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<!-- Modal duyệt -->
<div class="modal fade" id="approveModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered" role="document">
    <div class="modal-content" id="approveModalContent">
      <div class="p-4 text-center">
        <i class="fas fa-spinner fa-spin"></i> Đang tải...
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const $modal   = document.getElementById('approveModal');
  const $content = document.getElementById('approveModalContent');

  function getCookie(name){
    const v = ('; '+document.cookie).split('; '+name+'=');
    if (v.length === 2) return v.pop().split(';').shift();
  }

  // Mở modal -> load form duyệt
  if (window.jQuery && $modal) {
    jQuery($modal).on('show.bs.modal', function(e){
      const btn = jQuery(e.relatedTarget);
      const url = btn.data('url');
      $content.innerHTML = '<div class="p-4 text-center"><i class="fas fa-spinner fa-spin"></i> Đang tải...</div>';

      fetch(url, {credentials: 'same-origin'})
        .then(r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
        .then(html => { $content.innerHTML = html; })
        .catch(err => { $content.innerHTML = '<div class="p-4 text-danger">Tải form phê duyệt thất bại: '+err.message+'</div>'; });
    });
  } else {
    // Fallback nếu không có jQuery
    document.addEventListener('click', function(e){
      const btn = e.target.closest('[data-target="#approveModal"][data-url]');
      if (!btn) return;
      const url = btn.getAttribute('data-url');
      $content.innerHTML = '<div class="p-4 text-center"><i class="fas fa-spinner fa-spin"></i> Đang tải...</div>';
      fetch(url, {credentials: 'same-origin'})
        .then(r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
        .then(html => { $content.innerHTML = html; })
        .catch(err => { $content.innerHTML = '<div class="p-4 text-danger">Tải form phê duyệt thất bại: '+err.message+'</div>'; });
    });
  }

  // Submit phê duyệt trong modal
  document.addEventListener('submit', function(e){
    const form = e.target;
    if (form && form.id === 'approveForm') {
      e.preventDefault();
      const fd = new FormData(form);

      fetch(form.action, {
        method: 'POST',
        body: fd,
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        credentials: 'same-origin'
      })
      .then(async (r) => {
        const ct = r.headers.get('content-type') || '';
        if (ct.includes('application/json')) {
          const data = await r.json();
          if (data.ok) {
            if (window.jQuery) jQuery('#approveModal').modal('hide');
            location.reload();
          } else if (data.html) {
            $content.innerHTML = data.html; // render lại form kèm lỗi
          } else {
            throw new Error('Phê duyệt không thành công');
          }
        } else {
          location.reload(); // fallback
        }
      })
      .catch(err => {
        $content.innerHTML = '<div class="p-3 text-danger">Có lỗi khi gửi phê duyệt: '+err.message+'</div>';
      });
    }
  });
})();
</script>

<style>
/* Bảng responsive */
.table-responsive{ overflow-x:auto !important; -webkit-overflow-scrolling:touch; }
.table{ min-width:1380px; table-layout:fixed; }

/* Cell mặc định */
.table th,.table td{ vertical-align:middle; padding:.5rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

/* Nội dung sát đỉnh */
.td-top{ vertical-align:top !important; }

/* Cột dài cho phép xuống dòng */
.cell-multiline{ white-space:pre-line; word-break:break-word; overflow-wrap:anywhere; }

/* Kích thước cột */
.col-stt{width:50px;}
.col-title{width:140px;}
.col-content{width:280px;}
.col-dept{width:100px;}
.col-assignee{width:90px;}
.col-progress{width:110px; text-align:center;}
.col-updates{width:240px;}
.col-support{width:90px;}
.col-deadline{width:140px; text-align:center;}
.col-feedback{width:170px;}
.col-actions{width:80px; white-space:nowrap;}

/* Progress rõ hơn */
.progress-strong{
  height:12px; border:1px solid #dbe1ea; background:#eef2f7;
  border-radius:999px; overflow:hidden;
}
.progress-strong .progress-bar{ height:100%; border-radius:999px; box-shadow:inset 0 -1px 0 rgba(0,0,0,.12); }

/* ===== Cột cập nhật: top card + bottom actions ===== */
.td-updates{ padding:.5rem; vertical-align:top !important; }
.updates-cell{ display:flex; flex-direction:column; min-height:48px; height:100%; }
.update-card{
  border:1px solid #e9ecef; background:#fff; border-radius:8px;
  padding:.4rem .55rem; max-height:72px; overflow:hidden;
}
.uc-row{ display:flex; align-items:center; justify-content:space-between; margin-bottom:.1rem; font-weight:600; }
.uc-badge{ margin-left:.5rem; }
.uc-time{ font-size:.85rem; color:#6c757d; }
.uc-meta{ font-size:.8rem; color:#6c757d; margin-bottom:.05rem; }
.uc-note{
  display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
  overflow:hidden; word-break:break-word; white-space:normal; line-height:1.25;
}
.uc-empty{ font-size:.85rem; color:#6c757d; text-align:center; padding:.2rem 0; }

/* nút dưới cùng */
.update-actions{ display:flex; gap:.35rem; margin-top:auto; align-self:flex-start; }
.btn-compact{ padding:.18rem .5rem; font-size:.75rem; line-height:1; }

/* Badge nhỏ */
.badge{white-space:normal; line-height:1.2; font-size:.75em; padding:.3em .5em; margin:.1em;}

/* Thẻ điểm nổi bật */
.rating-card{
  display:flex; align-items:center; gap:.5rem;
  background:#f8fafc; border:1px solid #e7edf3; border-left-width:6px;
  border-radius:10px; padding:.45rem .6rem;
}
.rating-card.good{ border-left-color:#28a745; }
.rating-card.medium{ border-left-color:#ffc107; }
.rating-card.bad{ border-left-color:#dc3545; }
.rc-left{ display:flex; align-items:center; }
.rc-left .fa-star{ margin-right:.35rem; color:#ffc107; }
.rc-score{ font-weight:800; font-size:1.05rem; margin-right:.1rem; }
.rc-total{ color:#6c757d; font-weight:600; }
.rc-comment{ font-size:.85rem; line-height:1.25; word-break:break-word; }
.rc-comment.muted{ color:#6c757d; font-style:italic; }

/* Phân tách lịch sử khỏi thẻ điểm */
.history-box{
  border-top:1px dashed #e7edf3;
  padding-top:.45rem;
  margin-top:.35rem;
}

/* Ẩn bớt cột phụ trên màn nhỏ */
@media (max-width:1200px){ .col-support,.col-deadline{display:none;} }
@media (max-width:768px){ .table{font-size:.85rem;} .btn-compact{padding:.16rem .45rem;} }
</style>
{% endblock %}

